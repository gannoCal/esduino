// filename ******** Main.C ************** 

//***********************************************************************
// Simple ADC example for the Technological Arts EsduinoXtreme board
// by Carl Barnes, 12/03/2014
//***********************************************************************

#include <hidef.h>      /* common defines and macros */
#include "derivative.h"  /* derivative information */
#include "SCI.h"
#include "stdlib.h"
#include "stdio.h"
#include "math.h"
//#include "LUT.h"

char string[20];
unsigned short val;
short theta; 
long g;
short LUT[1001];
long LUT_i; 

void msDelay(unsigned int);


//---------------------OutCRLF---------------------
// Output a CR,LF to SCI to move cursor to a new line
// Input: none
// Output: none
// Toggle LED each time through the loop

void OutCRLF(void){
  SCI_OutChar(CR);
  SCI_OutChar(LF);
  PTJ ^= 0x20;          // toggle LED D2
}

void main(void) {
// Setup and enable ADC channel 0
// Refer to Chapter 14 in S12G Reference Manual for ADC subsystem details
        
    ATDCTL1 = 0x4F;     // set for 12-bit resolution
    ATDCTL3 = 0x88;     // right justified, one sample per sequence
    ATDCTL4 = 0x02;     // prescaler = 2; ATD clock = 6.25MHz / (2 * (2 + 1)) == 1.04MHz
    ATDCTL5 = 0x25;     // continuous conversion on channel 0
    
// Configure Timer for PWM on channel 0 (uncomment below for milestone 2)
// PWMCTL= 0x??
// PWMCLK= 0x??
// PWMCLKAB= 0x??
// PWMPRCLK= 0x??
// PWME= 0x??

// Configure PWM preoperties (uncomment below for milestone 2)
// PWMPOL= 0x??
// PWMPER0= ?
// PWMCAE= 0x??
// PWMDTY0= ?


// Setup LED and SCI
  DDRJ |= 0x01;     // PortJ bit 0 is output to LED D2 on DIG13
  SCI_Init(9600);
  
  //LUT=getLUT();
  LUT[]={-90,-86,-85,-84,-83,-82,-81,-80,-80,-79,-79,-78,-77,-77,-76,-76,-75,-75,-75,-74,-74,-73,-73,-73,-72,-72,-71,-71,-71,-70,-70,-70,-69,-69,-69,-68,-68,-68,-68,-67,-67,-67,-66,-66,-66,-66,-65,-65,-65,-64,-64,-64,-64,-63,-63,-63,-63,-62,-62,-62,-62,-61,-61,-61,-61,-60,-60,-60,-60,-60,-59,-59,-59,-59,-58,-58,-58,-58,-58,-57,-57,-57,-57,-57,-56,-56,-56,-56,-55,-55,-55,-55,-55,-54,-54,-54,-54,-54,-54,-53,-53,-53,-53,-53,-52,-52,-52,-52,-52,-51,-51,-51,-51,-51,-51,-50,-50,-50,-50,-50,-49,-49,-49,-49,-49,-49,-48,-48,-48,-48,-48,-48,-47,-47,-47,-47,-47,-47,-46,-46,-46,-46,-46,-46,-45,-45,-45,-45,-45,-45,-44,-44,-44,-44,-44,-44,-43,-43,-43,-43,-43,-43,-43,-42,-42,-42,-42,-42,-42,-41,-41,-41,-41,-41,-41,-41,-40,-40,-40,-40,-40,-40,-39,-39,-39,-39,-39,-39,-39,-38,-38,-38,-38,-38,-38,-38,-37,-37,-37,-37,-37,-37,-37,-36,-36,-36,-36,-36,-36,-36,-35,-35,-35,-35,-35,-35,-35,-34,-34,-34,-34,-34,-34,-34,-34,-33,-33,-33,-33,-33,-33,-33,-32,-32,-32,-32,-32,-32,-32,-31,-31,-31,-31,-31,-31,-31,-31,-30,-30,-30,-30,-30,-30,-30,-29,-29,-29,-29,-29,-29,-29,-29,-28,-28,-28,-28,-28,-28,-28,-28,-27,-27,-27,-27,-27,-27,-27,-26,-26,-26,-26,-26,-26,-26,-26,-25,-25,-25,-25,-25,-25,-25,-25,-24,-24,-24,-24,-24,-24,-24,-24,-23,-23,-23,-23,-23,-23,-23,-23,-22,-22,-22,-22,-22,-22,-22,-22,-21,-21,-21,-21,-21,-21,-21,-21,-20,-20,-20,-20,-20,-20,-20,-20,-20,-19,-19,-19,-19,-19,-19,-19,-19,-18,-18,-18,-18,-18,-18,-18,-18,-17,-17,-17,-17,-17,-17,-17,-17,-16,-16,-16,-16,-16,-16,-16,-16,-16,-15,-15,-15,-15,-15,-15,-15,-15,-14,-14,-14,-14,-14,-14,-14,-14,-14,-13,-13,-13,-13,-13,-13,-13,-13,-12,-12,-12,-12,-12,-12,-12,-12,-12,-11,-11,-11,-11,-11,-11,-11,-11,-10,-10,-10,-10,-10,-10,-10,-10,-10,-9,-9,-9,-9,-9,-9,-9,-9,-9,-8,-8,-8,-8,-8,-8,-8,-8,-7,-7,-7,-7,-7,-7,-7,-7,-7,-6,-6,-6,-6,-6,-6,-6,-6,-6,-5,-5,-5,-5,-5,-5,-5,-5,-4,-4,-4,-4,-4,-4,-4,-4,-4,-3,-3,-3,-3,-3,-3,-3,-3,-3,-2,-2,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-0,-0,-0,-0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,16,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,30,30,30,30,30,30,30,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,33,33,33,33,33,33,33,34,34,34,34,34,34,34,34,35,35,35,35,35,35,35,36,36,36,36,36,36,36,37,37,37,37,37,37,37,38,38,38,38,38,38,38,39,39,39,39,39,39,39,40,40,40,40,40,40,41,41,41,41,41,41,41,42,42,42,42,42,42,43,43,43,43,43,43,43,44,44,44,44,44,44,45,45,45,45,45,45,46,46,46,46,46,46,47,47,47,47,47,47,48,48,48,48,48,48,49,49,49,49,49,49,50,50,50,50,50,51,51,51,51,51,51,52,52,52,52,52,53,53,53,53,53,54,54,54,54,54,54,55,55,55,55,55,56,56,56,56,57,57,57,57,57,58,58,58,58,58,59,59,59,59,60,60,60,60,60,61,61,61,61,62,62,62,62,63,63,63,63,64,64,64,64,65,65,65,66,66,66,66,67,67,67,68,68,68,68,69,69,69,70,70,70,71,71,71,72,72,73,73,73,74,74,75,75,75,76,76,77,77,78,79,79,80,80,81,82,83,84,85,86,90
 };
  
  for(;;) {
    PTJ ^= 0x01;          // toggle LED
    
    
    val=ATDDR0;
    g=((long)377*val-(long)490000)/(long)100;
    
    LUT_i=(g+970)/2;
    
    if(LUT_i<0){
      LUT_i=0;
    }
    if(LUT_i>1001){
      LUT_i=1001;
    }
    
    
   
    
    
    theta=LUT[LUT_i];
    
    sprintf(&string, "%d",theta);
    SCI_OutString(string);OutCRLF();
    //SCI_OutUDec((int)theta);OutCRLF();
    
    
    msDelay(250);    // 1 sec delay, you can validate using method outlined in Lecture W8-2_W8-3
  }
}

void msDelay(unsigned int time)
{
    unsigned int j,k;
    for(j=0;j<time;j++)
        for(k=0;k<1033;k++);
}

